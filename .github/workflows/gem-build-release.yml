name: Gem Build and Release
on: push

jobs:
  test:
    name: Test Gem
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.github_token }}

    steps:
    - uses: actions/checkout@v2
    - uses: ruby/setup-ruby@v1 # .ruby-version for ruby setup
      with:
        bundler-cache: true # bundle install and cache

    - name: Test
      run: bundle exec rake

  release:
    name:  Release Gem
    needs: test
    #if:    github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: ruby/setup-ruby@v1 # .ruby-version
      with:
        bundler-cache: true # bundle install and cache

    - name: Publish Gem
      uses: ./.github/actions/publish-gem-action
      with:
        token: ${{ secrets.github_token }}
